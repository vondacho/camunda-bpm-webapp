/* angular-data-depend - v1.0.0 - 2013-08-05 | (c) 2013 Nico Rehwaldt | MIT */
!function(a){function b(a){function b(a){return e(a)?a:[a]}function c(a){return Array.prototype.slice.apply(a)}var d=a.module("dataDepend",[]),e=a.isArray,f=a.isFunction,g=(a.isObject,a.forEach);a.extend;var h=["$rootScope","$q",function(b,d){function f(b){function f(a){function c(a){var b=C.value;C.$loaded=!0,z=!1,b!==a&&(C.value=a,r("setLoaded",b," -> ",a),k())}function e(a){var b=x[a];return b||(x[a]=b={}),b}function f(){C.$loaded=!1,A=!1}function h(a){var b=t[a];if(!b)throw new Error("[dataDepend] No provider for "+a);return b}function i(a){g(y,a)}function j(a){g(u,a)}function k(){i(function(a){a.parentChanged()})}function l(){function a(a,b){var c=e(a),d=c.value;r("resolveDependencies",a,":",d,"->",b),d!==b&&(r("resolveDependencies","changed"),c.value=b,z=!0)}var b=[];return j(function(c){var d=h(c),e=d.resolve().then(function(b){return a(c,b),b});b.push(e)}),d.all(b).then(function(){var b=[];return j(function(c){var d=h(c).get();a(c,d),b.push(d)}),b})}function m(a){f(),r("asyncLoad: init load");var b=l().then(function(c){if(r("asyncLoad dependencies resolved",c),B!==b)return r("asyncLoad: skip (new load request)"),B;var d=o();return v&&(z||a||0==c.length)&&(r("asyncLoad: call factory"),d=v.apply(v,c)),d}).then(function(a){return B!==b?(r("asyncLoad: skip (new load request)"),B):(r("asyncLoad: load complete"),B=null,c(a),a)});return b}function n(){return r("parentChanged START"),B?(r("parentChanged SKIP (loading)"),void 0):(A=!0,w&&(r("parentChanged RESOLVE async"),b(function(){r("parentChanged RESOLVE"),p()})),k(),void 0)}function o(){return C.value}function p(a){a=a||{};var b=a.reload;return(A||b)&&(B=m(b)),B?(r("resolve: load async"),B):(r("resolve: load sync"),d.when(o()))}function q(a){if(v)throw new Error("[dataDepend] Cannot set value, was using factory");c(a)}function r(){}a=a||{};var s=a.produces,t=a.registry,u=a.dependencies||[],v=a.factory,w=a.eager||!1,x={},y=[],z=!0,A=!0,B=null,C={$loaded:!1},D={produces:s,data:C,get:o,set:q,resolve:p,children:y,parentChanged:n};return j(function(a){h(a).children.push(D)}),w&&(r("resolve async"),b(function(){r("resolve"),p()})),v||c(a.value),D}function h(b,d){function f(a){return a?a[i]:a}function g(){var a=c(arguments);return k.apply(null,a).then(f)}function h(){var a=c(arguments);return f(j.apply(null,a))}if(!e(b.produces))throw new Error("[dataDepend] Provider does not produce multiple values");var i=b.produces.indexOf(d),j=b.get,k=b.resolve,l=a.extend({},b,{resolve:g,get:h});return l}return{filtered:h,create:f}}return f(function(a){b.$evalAsync(a)})}],i=["$rootScope","$injector","dataProviderFactory",function(a,c,d){function h(a){function c(c){function h(c,d){var g="provider$"+m++;if(d?c=b(c):(d=c,c=a(d),e(d)&&(d=d[d.length-1])),!f(d))throw new Error('[dataDepend] Must provide callback as second parameter or use [ "A", "B", function(a, b) { } ] notation');var h=i({produces:g,factory:d,dependencies:c,eager:!0,registry:n});return h.data}function i(a){var b,c=a.produces;if(!c)throw new Error("[dataDepend] Must provide produces when creating new provider");return b=d.create(a),e(c)?g(c,function(a){n[a]=d.filtered(b,a)}):n[c]=b,b}function j(a,b){b=b||a;var d=a+":old";k(a,c.$eval(b)),k(d,null);var e=n[a],f=n[d];return c.$watch(b,function(a,b){a!==b&&(e.set(a),f.set(b))}),e.data}function k(b,c){var d,g,h=n[b];if(h)return h.set(c),void 0;(f(c)||e(c))&&(d=c,g=a(d),c=void 0,e(d)&&(d=d[d.length-1]));var h=i({produces:b,factory:d,value:c,dependencies:g,registry:n});return h.data}function l(a){var b=n[a];if(!b)throw new Error('[dataDepend] Provider "'+a+'" does not exists');b.resolve({reload:!0})}var m=0,n={};return{$providers:n,get:h,set:k,changed:l,watchScope:j}}return{create:c}}return h(c.annotate,function(b){a.$evalAsync(b)})}];return d.factory("dataDependFactory",i),d.factory("dataProviderFactory",h),d}if("function"==typeof define&&define.amd)define(["angular"],function(a){return b(a)});else{if(void 0===typeof a)throw new Error("Cannot bind dataDepend: AngularJS not available on window or via AMD");b(a)}}(angular);